## Context
DiceThrone 当前实现假设“单对手”模型：大量路径通过 `find(id => id !== self)` 推导目标；胜负以个人 HP 为准；视图仅区分自己/对手。官方 2v2 规则要求四人分队、共享体力、目标掷骰和队伍交替回合，属于跨领域核心、服务端、前端展示的联动改造。

## Goals / Non-Goals
**Goals**
- 严格遵循规则文档 9.1 与 3.5 的 2v2 规则（分队、目标掷骰、共享体力、干预边界）。
- 保持 1v1 行为不回归，4 人对局进入 2v2 专用规则。
- 所有目标相关路径改为显式目标驱动，清理“唯一对手推断”隐式逻辑。

**Non-Goals**
- 不实现 3 人君临天下与 5-6 人变体（3 人模式另开独立提案，避免与 2v2 规则耦合）。
- 不在本次变更中扩展新英雄或新增非 2v2 相关视觉系统。

## Decisions
### 1) 团队状态显式建模（最正确方案）
在 `core` 中新增团队归属与共享体力字段（例如 teamIdByPlayerId / teamHealth），并提供统一查询函数（如 `getTeamId/getTeamHp/getOpponents`）。
- 原因：2v2 规则是架构级能力，必须由领域层显式表达；避免散落 if/else 与硬编码座位推断。

补充约束：
- 默认队伍配置为官方座位分队（1&3 vs 2&4）。
- 队伍由“当前站位”推导，不提供独立“手动分队”配置。
- 支持开局前手动调整站位，输入契约要求“只能移动到空位，不允许交换位”。

### 2) 回合顺序改为“起始玩家 + 队伍交替生成”
保留 `startingPlayerId`，在 4 人模式按座位映射动态生成交替序列：
- 起始在队伍 A：A1→A2→B1→B2
- 起始在队伍 B：B1→B2→A1→A2
并由 `getNextPlayerId` 统一消费。

### 3) 新增目标掷骰阶段，不复用现有 defensiveRoll
目标掷骰属于“确定防御方”的独立规则步骤，应作为显式 phase（仅 2v2 生效）接入 flow hooks。

### 4) 伤害/治疗统一走“队伍 HP 适配层”
不在各处直接读写 `player.resources[HP]`；改为统一入口（例如 `applyDamageToTargetTeam/applyHealToTargetTeam`）驱动共享体力。

### 5) 响应与可见性规则最小闭环
- 响应：允许队友改骰干预；禁止默认“替队友直接减伤/防御”路径，除非 action target 明确支持任意玩家。
- 响应队列：按阵营隔离，同队玩家不进入同队响应链（队友不响应队友）。
- 视图：队友手牌可见；对手手牌与牌库保持隐藏。

### 6) 红框站位交互（选角页，简化操作）
- 位置：使用你截图中的右下红框区域，作为 2v2 站位面板。
- 默认态：进入 4 人选角时展示默认站位（对应官方分队 1&3 vs 2&4）。
- 交互方式（最简）：
  - 第一步点击玩家头像（进入“待移动”状态）；
  - 第二步点击空位完成移动；
  - 点击已占用位置不执行交换，并给出轻提示“该位置已有人”。
- 权限：仅房主可编辑；非房主只读展示当前站位。
- 时机：房主点击开始后锁定，不允许对局中途再改。

### 7) 2v2 目标选择全流程交互
- 战斗主界面顶部固定展示 3 个他人悬浮窗（并排一行），用于持续展示目标信息。
- 3 个悬浮窗统一复用同一 UI 组件，仅通过数据驱动渲染。
- 悬浮窗边缘高亮必须区分敌我（敌方高亮色、友方高亮色）。
- 1/2：系统自动锁定“左侧对手”为目标，前端仅展示目标高亮与结果文案。
- 3/4：系统自动锁定“右侧对手”为目标，前端仅展示目标高亮与结果文案。
- 5：打开“目标选择面板”，展示 3 个目标项，按当前规则决定可点击项与默认焦点。
- 6：打开“目标选择面板”，展示 3 个目标项，按当前规则决定可点击项与默认焦点。
- 目标一旦确定：立即写入 `pendingAttack.defenderId` 并进入后续流程（防御/结算），同时在 UI 回显“本次目标”。
- 攻击阶段结束时：弹出目标选择面板，展示 3 个目标项；样式复用顶部悬浮窗并纵向排列，点击即确认。

## Risks / Trade-offs
- **高风险：伤害管线分散**（effects/tokenResponse/reduceCombat/executeTokens 均读 HP）
  - 缓解：先收敛统一查询/写入入口，再逐步替换调用点。
- **高风险：流程阶段膨胀**（targetingRoll 与现有 flowHalted 交互）
  - 缓解：为 targetingRoll 增加独立测试夹具，验证 autoContinue/responseWindow 的先后门控。
- **中风险：前端 4 人视图映射错误**
  - 缓解：引入“自/队友/左敌/右敌”语义选择器，避免直接按数组下标渲染。

## Open Questions
- 是否将“队友可见牌库内容”也开放？（规则仅明确“可查看队友手牌”，本提案默认仅开放手牌）
- 目标掷骰中“左/右对手”在 UI 层是否需要显式箭头提示？（不影响规则正确性，可后续增强）
