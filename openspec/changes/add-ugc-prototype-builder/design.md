## Context
UGC 需要允许用户编写规则与视图代码以获得高自由度，但必须与官方游戏完全隔离，避免安全与稳定性风险。用户明确要求：外链网络仅允许图片；资源自动压缩且已是压缩格式则跳过；教程仅做“标注展示”。

## Goals / Non-Goals
### Goals
- 规则执行在服务端沙箱，视图在客户端 iframe 沙箱运行，整局 UGC 游戏级隔离。
- 提供 UGC 原型制作器，覆盖卡牌/阶段/目标选择/伤害/抽弃牌基础能力与模板。
- 资源上传自动压缩并保留原始格式，兼容未来对象存储。
- 教程支持右键标注与展示，不要求强制步骤控制。

### Non-Goals
- 不实现 UGC 审核/上架/市场化流程。
- 不在主站直接执行用户视图代码。
- 不在本阶段实现完整的教程步骤编排器（仅标注展示）。

## Decisions
1. **运行时隔离**：每个 UGC 游戏实例使用单一 iframe 沙箱渲染视图；规则在服务端沙箱执行，禁止访问 `fs/net/process`。
2. **SDK 通信边界**：视图仅通过受限 SDK 与宿主通信（postMessage），宿主校验并执行动作。
3. **网络访问策略**：仅允许外链图片资源；禁止任意 `fetch` 外部 API（CSP 限制）。
4. **资源处理管线**：服务端压缩为主，**不保留原图**以节省云端空间；若已是压缩格式（如 webp/avif/ogg/mp3）则跳过压缩；输出压缩变体并写入元数据。
5. **原型制作器模板**：以卡牌/阶段/目标选择/抽弃牌为核心组件，并提供提示词与代码模板一键复制。
6. **教程标注展示**：通过 `data-ugc-id` 绑定标注内容，进入教程模式时覆盖层展示描述。

## Alternatives Considered
- **组件级沙箱**：成本高、通信复杂、调试困难，放弃。
- **在主站执行用户代码**：安全与稳定性风险不可控，放弃。
- **仅规则沙箱 + 视图 DSL**：自由度不足，放弃。

## Risks / Trade-offs
- iframe + postMessage 带来性能与调试成本。
- SDK 需要持续扩展以满足自由度需求。
- 外链图片可能失效或引入追踪风险。

## Migration Plan
- 新增 UGC 运行路径与资源管线，不影响现有官方游戏。
- UGC 模块与宿主隔离，逐步扩展 SDK 能力。

## Open Questions
- 需要确认压缩质量参数与目标尺寸策略（如 WebP 质量、最大宽高）。
- 是否需要提供外链图片代理/缓存以保证稳定性。
